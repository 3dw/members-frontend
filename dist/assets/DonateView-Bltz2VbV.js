import{_ as F,c as n,e,f as i,i as r,w as c,j as p,F as C,g as B,k as A,l as E,v as y,m as v,p as D,q as g,u as b,x as k,h as s,y as f,t as w}from"./index-svhgGHUl.js";import{_}from"./donate_heart-DYa2zWJJ.js";const T={props:{devMode:{type:Boolean,required:!0,default:!1}},data(){return{selectedAmount:"150",customAmount:150,mode:"donate-by-card",modes:["donate-by-card","donate-by-qrcode","donate-by-bank-transfer","donate-by-code"],merchantID:"3214475",returnURL:"https://members-backend.alearn13994229.workers.dev/donation_callback",checkMacValue:"",clientBackURL:window.location.origin+"/donate",status:"",showDonationStatus:!1,pollingInterval:null}},async mounted(){this.checkMacValue=await this.generateCheckMacValue();const u=new URLSearchParams(window.location.search).get("merchantTradeNo");u&&(this.showDonationStatus=!0,this.startPolling(u))},computed:{donationAmount(){return this.selectedAmount==="custom"?this.customAmount:parseInt(this.selectedAmount)},merchantTradeNo(){return`DON${Date.now()}${Math.floor(Math.random()*1e3)}`},merchantTradeDate(){return new Date().toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/(\d+)\/(\d+)\/(\d+)/,"$1/$2/$3")}},watch:{async donationAmount(){this.checkMacValue=await this.generateCheckMacValue()}},methods:{parse(o){if(o==="donate-by-card")return"信用卡捐贈";if(o==="donate-by-bank-transfer")return"銀行匯款捐贈";if(o==="donate-by-qrcode")return"QR Code掃碼捐贈";if(o==="donate-by-code")return"愛心碼捐贈"},clearCustomAmount(){this.selectedAmount!=="custom"&&(this.customAmount=150)},async generateCheckMacValue(){const o={MerchantID:this.merchantID,MerchantTradeNo:this.merchantTradeNo,MerchantTradeDate:this.merchantTradeDate,PaymentType:"aio",TotalAmount:this.donationAmount,TradeDesc:"自主學習促進會捐款",ItemName:"捐款",ReturnURL:this.returnURL,ChoosePayment:"Credit",EncryptType:"1",ClientBackURL:this.clientBackURL},u=Object.keys(o).sort(),d="uwd8iyVvedwkGKY7",m="IsVGPnoyr1xzvExa";let t="HashKey="+d;u.forEach(a=>{t+="&"+a+"="+o[a]}),t+="&HashIV="+m;let l=encodeURIComponent(t).toLowerCase();return l=l.replace(/%20/g,"+").replace(/%2d/g,"-").replace(/%5f/g,"_").replace(/%2e/g,".").replace(/%21/g,"!").replace(/%2a/g,"*").replace(/%28/g,"(").replace(/%29/g,")"),(await this.sha256(l)).toUpperCase()},sha256(o){const u=new TextEncoder().encode(o);return crypto.subtle.digest("SHA-256",u).then(d=>Array.from(new Uint8Array(d)).map(m=>m.toString(16).padStart(2,"0")).join(""))},async checkDonationStatus(o){try{const d=await(await fetch(`https://members-backend.alearn13994229.workers.dev/check_donation_status/${o}`)).json();d&&d.status?this.status=d.status:this.status="pending"}catch(u){console.error("檢查捐款狀態時發生錯誤:",u)}},handleSubmit(){this.showDonationStatus=!0,this.startPolling(this.merchantTradeNo)},startPolling(o){this.status="pending",this.checkDonationStatus(o),this.pollingInterval=setInterval(()=>{this.checkDonationStatus(o),(this.status==="success"||this.status==="failed"||this.status==="simulated")&&this.pollingInterval&&clearInterval(this.pollingInterval)},1e4),setTimeout(()=>{this.pollingInterval&&clearInterval(this.pollingInterval)},5*60*1e3)}},beforeUnmount(){this.pollingInterval&&clearInterval(this.pollingInterval)}},S={class:"ui segment container"},I={key:0,class:"ui segment"},V={key:0,class:"ui segment"},M={key:1,class:"ui segment"},R={key:2,class:"ui segment"},U={key:3,class:"ui segment"},L={class:"ui header"},N={key:0},x={key:1},P={key:2},q={key:3},Q={class:"ui vertical buttons"},H=["onClick"],G={class:"ui form"},j={class:"ui two stackable fields"},z={class:"compact field"},K={key:0,class:"field"},O=["value"],W=["value"],Y=["value"],X=["value"],Z=["value"],J=["value"],$=["value"],uu={key:1,class:"ui divider"},eu={key:2,class:"ui segment"},tu={key:3,class:"ui segment"},nu={key:4,class:"ui segment"},su={key:1,class:"ui divider"},ou={key:2,class:"fluid segment"};function au(o,u,d,m,t,l){const h=k("RouterLink");return s(),n("div",S,[t.showDonationStatus?(s(),n("div",I,[t.status==="success"?(s(),n("div",V,u[4]||(u[4]=[e("h2",{class:"main-title"},"捐款完成，謝謝您的愛心❤️",-1)]))):i("",!0),t.status==="failed"?(s(),n("div",M,u[5]||(u[5]=[e("h2",{class:"main-title"},"捐款失敗❤️",-1),e("p",null,"很抱歉，您的捐款處理失敗。請嘗試其他捐款方式或稍後再試。",-1)]))):i("",!0),t.status==="simulated"?(s(),n("div",R,u[6]||(u[6]=[e("h2",{class:"main-title"},"模擬捐款完成❤️",-1),e("p",null,"這是一筆測試性質的捐款，並未實際進行交易。",-1)]))):i("",!0),t.status==="pending"?(s(),n("div",U,u[7]||(u[7]=[e("h2",{class:"main-title"},"處理中❤️",-1),e("p",null,[r("您的捐款正在處理中，請稍候"),e("span",{class:"ellipsis"},"...")],-1)]))):i("",!0)])):i("",!0),c(e("div",null,[e("h2",L,[u[8]||(u[8]=e("span",null,[e("i",{class:"dollar icon"})],-1)),t.mode==="donate-by-card"?(s(),n("span",N,"信用卡捐贈")):t.mode==="donate-by-qrcode"?(s(),n("span",x,"QR Code掃碼捐贈")):t.mode==="donate-by-bank-transfer"?(s(),n("span",P,"銀行匯款捐贈")):t.mode==="donate-by-code"?(s(),n("span",q,"愛心碼捐贈")):i("",!0),u[9]||(u[9]=e("span",null,"   ",-1)),e("div",Q,[(s(!0),n(C,null,B(t.modes,a=>(s(),n("button",{class:f(["ui basic green large button",{active:t.mode===a}]),key:a,onClick:iu=>t.mode=a},w(l.parse(a)),11,H))),128))]),u[10]||(u[10]=e("img",{src:_,alt:"捐贈愛心",class:"donate-heart"},null,-1))]),t.mode==="donate-by-card"?(s(),n("form",{key:0,method:"post",onSubmit:u[3]||(u[3]=(...a)=>l.handleSubmit&&l.handleSubmit(...a)),action:"https://payment.ecpay.com.tw/Cashier/AioCheckOut/V5",target:"_blank"},[e("div",G,[e("div",j,[e("div",z,[u[12]||(u[12]=e("label",null,"選擇捐贈金額",-1)),c(e("select",{"onUpdate:modelValue":u[0]||(u[0]=a=>t.selectedAmount=a),onChange:u[1]||(u[1]=(...a)=>l.clearCustomAmount&&l.clearCustomAmount(...a))},u[11]||(u[11]=[A('<option value="150" data-v-9417497a>新台幣150元</option><option value="500" data-v-9417497a>新台幣500元</option><option value="1000" data-v-9417497a>新台幣1000元</option><option value="2000" data-v-9417497a>新台幣2000元</option><option value="custom" data-v-9417497a>自訂金額</option>',5)]),544),[[E,t.selectedAmount]])]),t.selectedAmount==="custom"?(s(),n("div",K,[u[13]||(u[13]=e("label",null,"自訂金額：新台幣",-1)),c(e("input",{type:"number","onUpdate:modelValue":u[2]||(u[2]=a=>t.customAmount=a),min:"150",placeholder:"輸入金額"},null,512),[[y,t.customAmount,void 0,{number:!0}]])])):i("",!0)]),e("input",{type:"hidden",name:"MerchantID",value:t.merchantID},null,8,O),e("input",{type:"hidden",name:"MerchantTradeNo",value:l.merchantTradeNo},null,8,W),e("input",{type:"hidden",name:"MerchantTradeDate",value:l.merchantTradeDate},null,8,Y),u[14]||(u[14]=e("input",{type:"hidden",name:"PaymentType",value:"aio"},null,-1)),e("input",{type:"hidden",name:"TotalAmount",value:l.donationAmount},null,8,X),u[15]||(u[15]=e("input",{type:"hidden",name:"TradeDesc",value:"自主學習促進會捐款"},null,-1)),u[16]||(u[16]=e("input",{type:"hidden",name:"ItemName",value:"捐款"},null,-1)),e("input",{type:"hidden",name:"ReturnURL",value:t.returnURL},null,8,Z),u[17]||(u[17]=e("input",{type:"hidden",name:"ChoosePayment",value:"Credit"},null,-1)),u[18]||(u[18]=e("input",{type:"hidden",name:"EncryptType",value:"1"},null,-1)),e("input",{type:"hidden",name:"CheckMacValue",value:t.checkMacValue},null,8,J),e("input",{type:"hidden",name:"ClientBackURL",value:t.clientBackURL},null,8,$),u[19]||(u[19]=e("button",{type:"submit",class:"ui basic green huge active button"},[e("i",{class:"dollar icon"}),r(" 捐贈 ")],-1))])],32)):i("",!0),t.mode==="donate-by-bank-transfer"?(s(),n("div",uu)):i("",!0),t.mode==="donate-by-bank-transfer"?(s(),n("div",eu,u[20]||(u[20]=[e("h3",null,[r("本會銀行帳戶： "),e("br"),r(" 台北富邦 士林分行（012） "),e("br"),r(" 帳號：30012-0000601 "),e("br"),r(" 戶名：社團法人中華民國自主學習促進會 ")],-1)]))):i("",!0),t.mode==="donate-by-qrcode"?(s(),n("div",tu,u[21]||(u[21]=[e("img",{id:"#donate-qrcode",src:v,alt:"線上捐款"},null,-1),e("p",null,"請掃描上方 QR Code",-1)]))):i("",!0),t.mode==="donate-by-code"?(s(),n("div",nu,u[22]||(u[22]=[e("h3",null,"以愛心碼「9806」捐助本會",-1),e("p",null,"本會是一個非營利組織，需要您的支持。",-1),e("p",null,"愛心碼取為「9806」，是因為最初成立的契機，在於1998~2006年的「台北市自主學習（中學六年一貫）實驗計畫」，本會第一代會員多是計畫中的親師生及關注計畫的學者賢達，別具意義。",-1),e("p",null,"邀請並歡迎大家未來在開立電子發票的商家購物時，可主動向店員要求使用愛心碼，說出捐贈碼9806，或出示條碼即可。發票若中獎，將會自動捐入本會！",-1),e("img",{id:"donate",src:D,alt:"愛心碼"},null,-1)]))):i("",!0)],512),[[p,!t.showDonationStatus]]),t.mode!=="donate-by-code"?(s(),n("div",su)):i("",!0),t.mode!=="donate-by-code"?(s(),n("div",ou,[e("h3",null,[u[24]||(u[24]=r("完成捐款後，請填寫下表，讓本會知道您的捐款資訊，將您列入 ")),g(h,{to:"/donate_records"},{default:b(()=>u[23]||(u[23]=[r("芳名錄")])),_:1}),u[25]||(u[25]=r(" ，並開立捐款收據給您，可供節稅："))]),u[26]||(u[26]=e("iframe",{src:"https://docs.google.com/forms/d/e/1FAIpQLSeUlMQeS4ztSkZ48GhytbQapT7TG-iBNB31YTWHVVT6XceGhQ/viewform?embedded=true",width:"100%",height:"4300",frameborder:"0",marginheight:"0",marginwidth:"0"},"載入中…",-1))])):i("",!0)])}const du=F(T,[["render",au],["__scopeId","data-v-9417497a"]]);export{du as default};
