import{_ as ue,r as v,c as q,o as de,a as ce,n as P,a7 as ve,a0 as fe,e as f,f as n,w as V,v as H,F as U,h as j,t as x,g as me,s as he,a8 as N,i as m,a9 as pe}from"./index-CxCwd2jm.js";const ge={class:"hello-view"},ye={key:0},we={class:"login-form"},be={class:"avatar-selection"},_e=["value"],Me={class:"avatar"},Te=["disabled"],xe={key:1},Ae={class:"welcome-message"},ke={key:0,class:"greeting-form"},Ce=["disabled"],Se={key:1},De={class:"pond-container"},$e={class:"messages-list"},Ee={key:0,class:"message-item"},Fe={class:"message-header"},Re={class:"avatar"},Ge={class:"username"},ze={class:"time"},Be={class:"message-content"},Le={__name:"HelloView",setup(Pe){const y=v(!1),A=v(""),C=v(""),w=v(""),b=v(""),O=v(["😊","🚀","🌟","☀️","💧","🌳"]),d=v([]),l=v(null);let i=null,h=null;const S=v([]),c=v([]),R=v(0),W=q(()=>{if(!y.value||!Array.isArray(d.value))return!1;const t=new Date().toDateString();return d.value.some(e=>e.username===C.value&&e.dateString===t)}),X=q(()=>[...d.value].sort((t,e)=>(e.timestamp||0)-(t.timestamp||0)));function Y(){A.value&&w.value&&(C.value=A.value,y.value=!0,P(()=>{G()}))}function J(){y.value=!1,C.value="",A.value="",w.value="",b.value="",h&&(cancelAnimationFrame(h),h=null),c.value=[],S.value=[],R.value=0,window.removeEventListener("resize",F)}function K(){if(!b.value||!y.value||W.value)return;const t=new Date,e={id:`msg-${t.getTime()}-${Math.random().toString(16).slice(2)}`,username:C.value,avatar:w.value,message:b.value,timestamp:t.getTime(),dateString:t.toDateString()},a=[...d.value,e];he(N,a).then(()=>{console.log("留言已寫入 Firebase"),l.value&&z(Math.random()*l.value.width,Math.random()*l.value.height),b.value=""}).catch(s=>{console.error("寫入 Firebase 時發生錯誤:",s)})}function G(){if(!l.value){console.error("Canvas element not found!");return}if(i=l.value.getContext("2d"),!i){console.error("Failed to get 2D context");return}F(),I(),ne(),window.addEventListener("resize",F)}function F(){if(!l.value||!i)return;const t=l.value.parentElement;t&&(l.value.width=t.clientWidth,l.value.height=t.clientHeight)}function I(){if(!Array.isArray(d.value))return;c.value.map(a=>a.id);const t=d.value;t.forEach(a=>{if(!a||!a.id)return;const s=c.value.findIndex(o=>o.id===a.id);s===-1?Q(a):(c.value[s].message=a.message,c.value[s].avatar=a.avatar,c.value[s].username=a.username)});const e=t.map(a=>a.id).filter(Boolean);c.value=c.value.filter(a=>e.includes(a.id))}function Q(t){if(!l.value)return;const e=l.value;c.value.push({id:t.id,avatar:t.avatar,username:t.username,message:t.message,x:Math.random()*(e.width-50)+25,y:Math.random()*(e.height-50)+25,vx:(Math.random()-.5)*.8,vy:(Math.random()-.5)*.8,size:30})}function z(t,e){S.value.push({x:t,y:e,radius:0,maxRadius:40+Math.random()*20,lineWidth:1.5,opacity:.7,speed:.8+Math.random()*.4})}function Z(){if(!i||!l.value)return;const t=l.value;i.clearRect(0,0,t.width,t.height);const e=i.createLinearGradient(0,0,0,t.height);e.addColorStop(0,"#a0d8f0"),e.addColorStop(1,"#79c2e6"),i.fillStyle=e,i.fillRect(0,0,t.width,t.height)}function ee(){if(i)for(let t=S.value.length-1;t>=0;t--){const e=S.value[t];i.beginPath(),i.arc(e.x,e.y,e.radius,0,Math.PI*2),i.strokeStyle=`rgba(255, 255, 255, ${e.opacity})`,i.lineWidth=e.lineWidth,i.stroke(),e.radius+=e.speed,e.opacity-=.01,(e.radius>e.maxRadius||e.opacity<=0)&&S.value.splice(t,1)}}function te(t,e,a,s,o,D,k,le,oe,re){if(!e)return;t.font=re,t.textBaseline="top";const B=e.split(" "),$=[];let E=B[0];for(let T=1;T<B.length;T++){const g=B[T];t.measureText(E+" "+g).width<o?E+=" "+g:($.push(E),E=g)}$.push(E);let L=0;$.forEach(T=>{const g=t.measureText(T).width;g>L&&(L=g)});const _=L+k*2,M=$.length*D+k*2,r=a-_/2,u=s-M-5;t.fillStyle=le;const p=6;t.beginPath(),t.moveTo(r+p,u),t.lineTo(r+_-p,u),t.quadraticCurveTo(r+_,u,r+_,u+p),t.lineTo(r+_,u+M-p),t.quadraticCurveTo(r+_,u+M,r+_-p,u+M),t.lineTo(r+p,u+M),t.quadraticCurveTo(r,u+M,r,u+M-p),t.lineTo(r,u+p),t.quadraticCurveTo(r,u,r+p,u),t.closePath(),t.fill(),t.fillStyle=oe,$.forEach((T,g)=>{t.fillText(T,r+k,u+k+g*D)})}function ae(){if(!i||!l.value)return;const t=l.value;c.value.forEach(e=>{e.x+=e.vx,e.y+=e.vy;const a=70,s=e.size/2;e.x-s<0?(e.x=s,e.vx*=-1):e.x+s>t.width&&(e.x=t.width-s,e.vx*=-1),e.y-s-a<0?(e.y=s+a,e.vy=Math.abs(e.vy)):e.y+s>t.height&&(e.y=t.height-s,e.vy*=-1);const o=`${e.avatar} ${e.username}
${e.message}`;te(i,o,e.x,e.y-s,130,16,8,"rgba(255, 255, 255, 0.85)","#333","14px sans-serif"),i.font=`${e.size}px sans-serif`,i.textAlign="center",i.textBaseline="middle",i.fillText(e.avatar,e.x,e.y)})}function se(){if(l.value&&Math.random()<.015){const t=Math.random()*l.value.width,e=Math.random()*l.value.height;z(t,e)}}function ne(){h&&cancelAnimationFrame(h);const t=()=>{Z(),se(),ee(),ae(),h=requestAnimationFrame(t)};t()}de(()=>{ce(N,t=>{let e=[];if(t.exists()){const a=t.val();Array.isArray(a)?(e=a,e.forEach((s,o)=>{s.id||(s.id=`fallback-${s.timestamp||o}-${Math.random().toString(16).slice(2)}`),typeof s.message>"u"&&(s.message="")})):a&&typeof a=="object"&&(e=Object.entries(a).map(([s,o])=>({id:s,message:o.message||"",...o})))}d.value=e,i&&I(),d.value.length>R.value&&l.value&&i&&z(Math.random()*l.value.width,Math.random()*l.value.height),R.value=d.value.length},t=>{console.error("Error fetching data from Firebase:",t),d.value=[],c.value=[]}),y.value&&P(()=>{G()})}),ve(()=>{h&&(cancelAnimationFrame(h),h=null),window.removeEventListener("resize",F)}),fe(y,t=>{t&&P(()=>{i||G()})});function ie(t){if(!t)return"";const e=new Date(t),s=new Date().getTime()-e.getTime(),o=Math.floor(s/(60*1e3)),D=Math.floor(s/(60*60*1e3)),k=Math.floor(s/(24*60*60*1e3));return o<60?`${o} 分鐘前`:D<24?`${D} 小時前`:`${k} 天前`}return(t,e)=>(m(),f("div",ge,[y.value?(m(),f("div",xe,[n("div",Ae,[n("h2",null,"Hi, "+x(C.value)+" ("+x(w.value)+")!",1),n("button",{onClick:J},"離開池塘")]),W.value?(m(),f("p",Se,"你今天已經打過招呼了！")):(m(),f("div",ke,[V(n("textarea",{"onUpdate:modelValue":e[2]||(e[2]=a=>b.value=a),placeholder:"今天想說些什麼？"},null,512),[[H,b.value,void 0,{trim:!0}]]),n("button",{onClick:K,disabled:!b.value},"向大家打招呼！",8,Ce)])),e[7]||(e[7]=n("h3",{class:"pond-title"},"今日池塘動態",-1)),n("div",De,[n("canvas",{class:"pond-canvas",ref_key:"pondCanvas",ref:l},null,512)]),e[8]||(e[8]=n("h3",{class:"messages-title"},"池塘訊息列表",-1)),n("div",$e,[d.value.length===0?(m(),f("div",Ee,e[6]||(e[6]=[n("p",{class:"empty-message"},"今天池塘很安靜... 快來打聲招呼吧！",-1)]))):me("",!0),(m(!0),f(U,null,j(X.value,a=>(m(),f("div",{class:"message-item",key:a.id},[n("div",Fe,[n("span",Re,x(a.avatar||"💧"),1),n("span",Ge,x(a.username),1),n("span",ze,x(ie(a.timestamp)),1)]),n("div",Be,x(a.message),1)]))),128))])])):(m(),f("div",ye,[e[5]||(e[5]=n("h2",null,"加入池塘對話！",-1)),n("div",we,[e[3]||(e[3]=n("label",{for:"username"},"你的名字：",-1)),V(n("input",{type:"text",id:"username","onUpdate:modelValue":e[0]||(e[0]=a=>A.value=a),placeholder:"輸入你的暱稱"},null,512),[[H,A.value,void 0,{trim:!0}]]),e[4]||(e[4]=n("label",null,"頭像選擇：",-1)),n("div",be,[(m(!0),f(U,null,j(O.value,(a,s)=>(m(),f("label",{key:s},[V(n("input",{type:"radio",name:"avatar",value:a,"onUpdate:modelValue":e[1]||(e[1]=o=>w.value=o)},null,8,_e),[[pe,w.value]]),n("span",Me,x(a),1)]))),128))]),n("button",{onClick:Y,disabled:!A.value||!w.value},"進入池塘",8,Te)])]))]))}},Ie=ue(Le,[["__scopeId","data-v-3b781e4e"]]);export{Ie as default};
