import{d as ge,r as g,c as X,o as fe,n as me,b as y,e as T,a as O,aa as ye,T as Y,s as J,ac as j,g as r,h as o,w as K,v as Q,t as d,i as Z,F as P,j as E,l as x,m as z,z as Te,A as we,ad as Ce,ab as F,k as u,_ as ke}from"./index-B5XOrBgH.js";const Me=ge({name:"TroubleTreeView",props:{users:{type:Object,required:!1,default:()=>[]},uid:{type:String,required:!1,default:"匿名"}},setup(s){const n={personal:"個人成長",relationship:"人際關係",career:"工作職涯",family:"家庭困擾",health:"身心健康"},q=t=>({personal:"#2e7d32",relationship:"#1b5e20",career:"#388e3c",family:"#43a047",health:"#4caf50"})[t]||"#2e7d32",f=g([]),k=g([]),M=g(null),l=g(null),p=X(()=>f.value.find(t=>t.id===l.value)),w=g({content:"",category:"personal"}),C=g({content:"",troubleId:""}),R=g(""),L=g(""),D=g(!1),V=g(null),ee=X(()=>M.value?f.value.filter(t=>t.category===M.value):f.value),te=t=>{const e=new Date(t),a=Math.floor((new Date().getTime()-e.getTime())/(1e3*60*60*24));return a===0?"今天 "+e.toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"}):a===1?"昨天 "+e.toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"}):a<7?`${a}天前`:e.toLocaleDateString("zh-TW",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})},A=()=>{if(!V.value)return;const t=V.value,e=t.getContext("2d");if(!e)return;t.width=window.innerWidth,t.height=window.innerHeight;const h=e.createLinearGradient(0,0,0,t.height);h.addColorStop(0,"#e8f5e9"),h.addColorStop(1,"#c8e6c9"),e.fillStyle=h,e.fillRect(0,0,t.width,t.height);const a=Math.min(t.width*.18,180),c=t.height*.65,i=t.width-a-20,b=t.height-c-20,_=e.createLinearGradient(i,b,i+a,b);_.addColorStop(0,"#5D4037"),_.addColorStop(.6,"#795548"),_.addColorStop(1,"#6D4C41"),e.fillStyle=_,e.beginPath(),e.moveTo(i,b+c),e.lineTo(i+a*.8,b+c),e.lineTo(i+a,b+c*.9),e.lineTo(i+a,b+c*.3),e.lineTo(i+a*.7,b),e.lineTo(i+a*.3,b),e.lineTo(i,b+c*.3),e.closePath(),e.fill();const S=a*.6,$=c*.4,N=i+(a-S)/2,U=b+c*.45;e.fillStyle="#3E2723",e.beginPath(),e.ellipse(N+S/2,U+$/2,S/2,$/2,0,0,Math.PI*2),e.fill(),e.fillStyle="#1a1a1a",e.beginPath(),e.ellipse(N+S/2,U+$/2,S/2*.8,$/2*.8,0,0,Math.PI*2),e.fill();const ue=(v,m,I,H)=>{e.fillStyle=H,e.beginPath(),e.arc(v,m,I,0,Math.PI*2),e.fill()},ce=i+a/2,he=b*.7,B=["#2E7D32","#388E3C","#43A047","#4CAF50"];for(let v=0;v<100;v++){const m=Math.random()*Math.PI*2,I=Math.random()*a*2,H=ce+Math.cos(m)*I,pe=he+Math.sin(m)*I*.7,be=Math.random()*50+30,ve=B[Math.floor(Math.random()*B.length)];ue(H,pe,be,ve)}e.fillStyle="#795548",e.beginPath(),e.moveTo(0,t.height),e.lineTo(t.width,t.height),e.lineTo(t.width,t.height-20),e.quadraticCurveTo(t.width*.75,t.height-15,t.width*.5,t.height-30),e.quadraticCurveTo(t.width*.25,t.height-15,0,t.height-25),e.closePath(),e.fill(),e.fillStyle="#4CAF50";for(let v=0;v<t.width;v+=15){const m=Math.random()*10+5;e.beginPath(),e.moveTo(v,t.height),e.lineTo(v,t.height-m),e.lineTo(v+5,t.height-m-5),e.lineTo(v+10,t.height-m),e.lineTo(v+10,t.height),e.closePath(),e.fill()}},se=async()=>{try{if(!w.value.content.trim()){R.value="請輸入煩惱內容";return}D.value=!0;const t={content:w.value.content.trim(),category:w.value.category,timestamp:new Date().toISOString(),empathies:0,replyCount:0},e=y(T,"troubles"),h=Y(e);await J(h,{id:h.key,...t}),w.value.content="",R.value="",console.log("煩惱發布成功！")}catch(t){console.error("發布煩惱失敗：",t),R.value="發布失敗，請稍後再試"}finally{D.value=!1}},oe=async()=>{if(l.value)try{if(!C.value.content.trim()){L.value="請輸入回覆內容";return}D.value=!0;const t={troubleId:l.value,content:C.value.content.trim(),timestamp:new Date().toISOString(),helpful:0},e=y(T,"replies"),h=Y(e);await J(h,{id:h.key,...t});const a=y(T,`troubles/${l.value}`),c=p.value;if(c){const i=(c.replyCount||0)+1;await j(a,{replyCount:i})}C.value.content="",L.value="",console.log("回覆發布成功！")}catch(t){console.error("發布回覆失敗：",t),L.value="回覆發布失敗，請稍後再試"}finally{D.value=!1}},le=async t=>{if(!t)return;const e=y(T,`troubles/${t.id}`);await j(e,{empathies:(t.empathies||0)+1})},ne=async t=>{if(!t)return;const e=y(T,`replies/${t.id}`);await j(e,{helpful:(t.helpful||0)+1})},ae=t=>{M.value=t},ie=t=>{l.value=t.id,C.value.troubleId=t.id,de(t.id)},re=()=>{l.value=null,k.value=[],C.value.content="",C.value.troubleId=""},de=async t=>{const e=y(T,"replies");return O(e,a=>{const c=a.val();c?k.value=Object.values(c).filter(i=>i.troubleId===t).sort((i,b)=>new Date(b.timestamp).getTime()-new Date(i.timestamp).getTime()):k.value=[]})},G=()=>{A()};let W=null;return fe(()=>{me(()=>{A(),window.addEventListener("resize",G)});const t=y(T,"troubles");W=O(t,h=>{const a=h.val();a?(f.value=Object.values(a),f.value.sort((c,i)=>new Date(i.timestamp).getTime()-new Date(c.timestamp).getTime())):f.value=[]});const e=y(T,".info/connected");O(e,h=>{h.val()===!0?console.log("已連接到 Firebase"):console.log("未連接到 Firebase")})}),ye(()=>{W&&W(),window.removeEventListener("resize",G)}),{treeCanvas:V,troubles:f,replies:k,selectedFilter:M,selectedTroubleId:l,selectedTrouble:p,newTrouble:w,newReply:C,errorMessage:R,replyError:L,isLoading:D,filteredTroubles:ee,categoryMap:n,getCategoryColor:q,formatDate:te,addTrouble:se,addReply:oe,toggleEmpathy:le,toggleHelpful:ne,filterTroubles:ae,viewTroubleDetails:ie,backToList:re}}}),De={class:"trouble-tree-view"},Se={class:"tree-canvas",ref:"treeCanvas"},Re={class:"input-section"},Le={class:"trouble-input"},_e={class:"tree-hole-input"},$e=["disabled"],Ie={key:0,class:"error-message"},Pe={class:"category-selector"},Ee=["onClick"],ze={class:"category-tooltip"},Fe=["disabled"],Ve={key:0},We={key:1},He={class:"filter-section"},Oe=["onClick"],je={key:0,class:"troubles-container"},qe=["onClick"],Ae={class:"trouble-content"},Ge={class:"trouble-footer"},Ne={class:"trouble-info"},Ue={class:"trouble-timestamp"},Be={class:"trouble-stats"},Xe={class:"trouble-replies"},Ye={class:"reply-count"},Je={class:"trouble-empathies"},Ke={class:"empathy-count"},Qe={key:1,class:"trouble-detail"},Ze={class:"trouble-main"},xe={class:"trouble-content"},et={class:"trouble-footer"},tt={class:"trouble-info"},st={class:"trouble-timestamp"},ot={class:"trouble-actions"},lt={class:"empathy-count"},nt={class:"trouble-replies"},at={class:"replies-title"},it={class:"reply-form"},rt=["disabled"],dt={key:0,class:"error-message"},ut=["disabled"],ct={key:0},ht={key:1},pt={class:"replies-list"},bt={class:"reply-content"},vt={class:"reply-footer"},gt={class:"reply-timestamp"},ft={class:"reply-helpful"},mt=["onClick"],yt={class:"helpful-count"};function Tt(s,n,q,f,k,M){return u(),r("div",De,[o("canvas",Se,null,512),n[17]||(n[17]=o("div",{class:"header"},[o("h1",{class:"title"},"煩惱樹洞"),o("p",{class:"subtitle"},"向大自然樹洞傾訴，接收溫暖的回應")],-1)),o("div",Re,[o("div",Le,[o("div",_e,[n[7]||(n[7]=o("h3",{class:"input-title"},"向樹洞傾訴你的煩惱...",-1)),K(o("textarea",{"onUpdate:modelValue":n[0]||(n[0]=l=>s.newTrouble.content=l),placeholder:"點擊這裡，開始向樹洞傾訴...",rows:"4",disabled:s.isLoading},null,8,$e),[[Q,s.newTrouble.content]])]),s.errorMessage?(u(),r("div",Ie,d(s.errorMessage),1)):Z("",!0),o("div",Pe,[(u(!0),r(P,null,E(s.categoryMap,(l,p)=>(u(),r("div",{class:z(["category-option",{active:s.newTrouble.category===p}]),key:p,style:F({backgroundColor:s.getCategoryColor(p)}),onClick:w=>s.newTrouble.category=p},[o("span",ze,d(l),1)],14,Ee))),128))]),o("button",{class:"submit-btn",onClick:n[1]||(n[1]=(...l)=>s.addTrouble&&s.addTrouble(...l)),disabled:s.isLoading||!s.newTrouble.content.trim()},[s.isLoading?(u(),r("span",We,n[8]||(n[8]=[o("div",{class:"loading-spinner"},null,-1),x("送出中...")]))):(u(),r("span",Ve,"傾訴給樹洞"))],8,Fe)])]),o("div",He,[(u(!0),r(P,null,E(s.categoryMap,(l,p)=>(u(),r("button",{class:z(["filter-btn",{active:s.selectedFilter===p}]),key:p,style:F({backgroundColor:s.getCategoryColor(p)}),onClick:w=>s.filterTroubles(p)},d(l),15,Oe))),128)),o("button",{class:z(["filter-btn all",{active:s.selectedFilter===null}]),onClick:n[2]||(n[2]=l=>s.filterTroubles(null))},"全部",2)]),s.selectedTroubleId?(u(),r("div",Qe,[o("button",{class:"back-btn",onClick:n[3]||(n[3]=(...l)=>s.backToList&&s.backToList(...l))},"← 返回煩惱樹洞"),o("div",Ze,[o("div",{class:"trouble-category-tag",style:F({backgroundColor:s.selectedTrouble?s.getCategoryColor(s.selectedTrouble.category):"transparent"})},d(s.selectedTrouble?s.categoryMap[s.selectedTrouble.category]:""),5),o("div",xe,d(s.selectedTrouble?s.selectedTrouble.content:""),1),o("div",et,[o("div",tt,[o("span",st,d(s.selectedTrouble?s.formatDate(s.selectedTrouble.timestamp):""),1)]),o("div",ot,[o("button",{class:"empathy-btn",onClick:n[4]||(n[4]=l=>s.toggleEmpathy(s.selectedTrouble))},[n[12]||(n[12]=o("span",{class:"empathy-icon"},"🌱",-1)),n[13]||(n[13]=o("span",{class:"empathy-label"},"感同身受",-1)),o("span",lt,d(s.selectedTrouble&&s.selectedTrouble.empathies||0),1)])])])]),o("div",nt,[o("h3",at,"樹洞回應 ("+d(s.replies.length)+")",1),o("div",it,[K(o("textarea",{"onUpdate:modelValue":n[5]||(n[5]=l=>s.newReply.content=l),placeholder:"在此回應這個煩惱...",rows:"3",disabled:s.isLoading},null,8,rt),[[Q,s.newReply.content]]),s.replyError?(u(),r("div",dt,d(s.replyError),1)):Z("",!0),o("button",{class:"reply-btn",onClick:n[6]||(n[6]=(...l)=>s.addReply&&s.addReply(...l)),disabled:s.isLoading||!s.newReply.content.trim()},[s.isLoading?(u(),r("span",ht,n[14]||(n[14]=[o("div",{class:"loading-spinner"},null,-1),x("送出中...")]))):(u(),r("span",ct,"送出回應"))],8,ut)]),o("div",pt,[(u(!0),r(P,null,E(s.replies,l=>(u(),r("div",{class:"reply-card",key:l.id},[o("div",bt,d(l.content),1),o("div",vt,[o("div",gt,d(s.formatDate(l.timestamp)),1),o("div",ft,[o("button",{class:"helpful-btn",onClick:p=>s.toggleHelpful(l)},[n[15]||(n[15]=o("span",{class:"helpful-icon"},"🙏",-1)),n[16]||(n[16]=o("span",{class:"helpful-label"},"有幫助",-1)),o("span",yt,d(l.helpful||0),1)],8,mt)])])]))),128))])])])):(u(),r("div",je,[Te(Ce,{class:"troubles-grid",name:"trouble-list",tag:"div"},{default:we(()=>[(u(!0),r(P,null,E(s.filteredTroubles,l=>(u(),r("div",{class:z(["trouble-leaf",{"has-replies":l.replyCount>0}]),key:l.id,onClick:p=>s.viewTroubleDetails(l)},[n[11]||(n[11]=o("div",{class:"leaf-shape"},null,-1)),o("div",Ae,d(l.content),1),o("div",{class:"trouble-category-tag",style:F({backgroundColor:s.getCategoryColor(l.category)})},d(s.categoryMap[l.category]),5),o("div",Ge,[o("div",Ne,[o("span",Ue,d(s.formatDate(l.timestamp)),1)]),o("div",Be,[o("div",Xe,[n[9]||(n[9]=o("span",{class:"reply-icon"},"🍃",-1)),o("span",Ye,d(l.replyCount||0),1)]),o("div",Je,[n[10]||(n[10]=o("span",{class:"empathy-icon"},"🌱",-1)),o("span",Ke,d(l.empathies||0),1)])])])],10,qe))),128))]),_:1})]))])}const Ct=ke(Me,[["render",Tt],["__scopeId","data-v-2230886f"]]);export{Ct as default};
