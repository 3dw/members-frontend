import{d as P,r as w,c as Q,o as W,a as X,n as Y,s as k,b as g,e as y,f as Z,g as u,h as s,i as v,F as S,j as T,w as O,v as B,k as d,t as p,l as R,m as N,_ as j}from"./index-B5XOrBgH.js";const ee=P({props:{uid:{required:!1,default:""},users:{required:!1,default:()=>({})}},setup(e,{emit:l}){const c=w([{author:"AliceS",uid:"123",date:"2025-03-18 10:00:00",text:"This is a great post!"},{author:"BobS",uid:"456",date:"2025-03-18 10:00:00",text:"I totally agree with Alice."}].map(t=>({...t,reactions:{}}))),_=w(""),h=w(!1),b=w(-1),n=w("");w(-1);const M=Q(()=>[...c.value].map((t,i)=>{const o={...t};return o.actualIndex=i,o}).sort((t,i)=>{const o=new Date(t.date);return new Date(i.date).getTime()-o.getTime()})),a=()=>{if(!h.value)return;console.log(_.value);const t=c.value.length,i={author:e.users[e.uid].name||"匿名",uid:e.uid||"123",date:new Date().toISOString(),text:_.value,reactions:{}};c.value.push(i),_.value="",k(g(y,"bulletin/"+t),i).then(()=>{console.log("留言成功")})},C=()=>{l("toggleLogin")},f=t=>{const i=new Date,o=new Date(t);if(isNaN(o.getTime()))return"無效日期";const r=i.getTime()-o.getTime(),$=Math.floor(r/1e3),L=Math.floor(r/(1e3*60)),U=Math.floor(r/(1e3*60*60)),K=Math.floor(r/(1e3*60*60*24));return $<60?$===0?"剛剛":`${$} 秒前`:L<60?`${L} 分鐘前`:U<24?`${U} 小時前`:`${K} 天前`},D=t=>{e.uid&&(c.value[t].repliesExpanded?c.value[t].repliesExpanded=!1:c.value[t].repliesExpanded=!0,E())},V=(t,i,o,r)=>{e.uid&&(t.reactions||(t.reactions={}),t.reactions[r]||(t.reactions[r]={}),t.reactions[r][e.uid]?delete t.reactions[r][e.uid]:t.reactions[r][e.uid]=!0,k(g(y,`bulletin/${i}/replies/${o}/reactions`),t.reactions).then(()=>{console.log("回覆反應更新成功")}))},F=(t,i)=>{e.uid&&(t.reactions||(t.reactions={}),t.reactions[i]||(t.reactions[i]={}),t.reactions[i][e.uid]?delete t.reactions[i][e.uid]:t.reactions[i][e.uid]=!0,t.actualIndex!==void 0&&k(g(y,`bulletin/${t.actualIndex}/reactions`),t.reactions).then(()=>{console.log("反應更新成功")}))},x=(t,i)=>{var o,r;return((r=(o=t.reactions)==null?void 0:o[i])==null?void 0:r[e.uid])||!1},A=(t,i)=>{var o;return Object.keys(((o=t.reactions)==null?void 0:o[i])||{}).length},q=(t,i)=>{var o;return(o=t.reactions)!=null&&o[i]?Object.keys(t.reactions[i]).map(r=>{var $;return(($=e.users[r])==null?void 0:$.name)||"匿名用戶"}).join("、"):""},J=t=>{e.uid&&(b.value===t?b.value=-1:(b.value=t,n.value=""))},m=()=>{b.value=-1,n.value=""},z=t=>{if(!h.value||!e.uid||n.value.trim()==="")return;const i=c.value[t];i.replies||(i.replies=[]);const o={author:e.users[e.uid].name||"匿名",uid:e.uid,date:new Date().toISOString(),text:n.value.trim()};i.replies.push(o),n.value="",b.value=-1,k(g(y,`bulletin/${t}/replies`),i.replies).then(()=>{console.log("回覆新增成功")})},H=(t,i)=>{if(!h.value||!e.uid)return;const o=c.value[t];!o.replies||i>=o.replies.length||o.replies[i].uid!==e.uid||window.confirm("確定要刪除這則回覆嗎？")&&(o.replies.splice(i,1),k(g(y,`bulletin/${t}/replies`),o.replies).then(()=>{console.log("回覆刪除成功")}))},E=()=>{const t={};c.value.forEach((i,o)=>{i.repliesExpanded&&(t[o]=!0)}),sessionStorage.setItem("repliesExpandedState",JSON.stringify(t))},I=()=>{const t=sessionStorage.getItem("repliesExpandedState");if(t)try{const i=JSON.parse(t);c.value.forEach((o,r)=>{o.repliesExpanded=i[r]||!1})}catch(i){console.error("恢復展開狀態失敗",i)}},G=t=>{if(!h.value||!e.uid)return;const i=c.value[t];if(i.uid!==e.uid||i.replies&&i.replies.length>0)return;const o=prompt("編輯留言",i.text);o!==null&&o.trim()!==""&&(i.text=o.trim(),i.updated=new Date().toISOString(),k(g(y,`bulletin/${t}/text`),o.trim()).then(()=>{console.log("留言編輯成功")}),k(g(y,`bulletin/${t}/updated`),i.updated).then(()=>{console.log("更新時間記錄成功")}))};return W(()=>{console.log("mounted"),X(Z,t=>{const i=t.val();console.log(i),c.value=i.map(o=>({author:o.author,uid:o.uid,date:o.date,text:o.text,updated:o.updated,reactions:o.reactions||{},replies:o.replies?o.replies.map(r=>({author:r.author,uid:r.uid,date:r.date,text:r.text,reactions:r.reactions||{}})):[]})),h.value=!0,I()}),setInterval(async()=>{console.log("tick"),await Y(),c.value=[...c.value]},60*1e3)}),{messages:c,newMessage:_,addMessage:a,parseDate:f,toggleLogin:C,sortedMessages:M,toggleReaction:F,toggleReplyReaction:V,hasReacted:x,getReactionCount:A,getReactionUsers:q,dataLoaded:h,replyingTo:b,replyText:n,toggleReplyForm:J,addReply:z,cancelReply:m,toggleReplies:D,deleteReply:H,saveRepliesExpandedState:E,restoreRepliesExpandedState:I,editMessage:G}}}),te={class:"ui container two column stackable grid"},ne={key:0,class:"column"},se={class:"ui segment"},ie={key:1,class:"ui comments flex-column column"},oe={class:"content"},le=["src"],ae={class:"author"},ue={class:"metadata"},de={class:"date"},re={key:0,class:"updated"},ce={class:"text"},ve={class:"actions"},pe={class:"reaction-buttons"},fe=["onClick"],he={key:0,class:"reaction-tooltip"},be={class:"emoji"},ke={class:"count"},ge={class:"ui buttons"},ye=["onClick"],Re=["onClick"],Ce={key:0},$e={key:1},we=["onClick"],_e={key:1,class:"replies"},Se={key:0,class:"unexpended"},Te={key:1,class:"expended"},Me={class:"content"},De=["src"],Ee={class:"author"},Ie={class:"metadata"},Le={class:"date"},Ue={class:"text"},Oe={key:1,class:"actions"},Be={class:"reaction-buttons"},Ne=["onClick"],Ve={key:0,class:"reaction-tooltip"},Fe={class:"emoji"},xe={class:"count"},Ae={class:"ui buttons"},qe=["onClick"],Je=["onClick"],me={key:0},ze={key:1},He=["onClick"],Ge={key:2,class:"ui form reply-form"},Ke={class:"actions"},Pe=["onClick"],Qe={key:2,class:"ui form reply column"},We={class:"field"};function Xe(e,l,c,_,h,b){return d(),u("div",te,[e.uid?v("",!0):(d(),u("div",ne,[s("div",se,[l[5]||(l[5]=s("div",{class:"ui header"},"留言板",-1)),l[6]||(l[6]=s("div",{class:"ui description"},"請先登入才能留言",-1)),l[7]||(l[7]=s("div",{class:"ui divider"},null,-1)),s("button",{class:"ui large green basic button",onClick:l[0]||(l[0]=(...n)=>e.toggleLogin&&e.toggleLogin(...n))},"登入")])])),e.uid?(d(),u("div",ie,[(d(!0),u(S,null,T(e.sortedMessages,(n,M)=>(d(),u("div",{class:"comment",key:M},[s("div",oe,[e.users&&e.users[n.uid]&&e.users[n.uid].photoURL?(d(),u("img",{key:0,class:"ui avatar image",src:e.users[n.uid].photoURL},null,8,le)):v("",!0),s("div",ae,p(n.author),1),s("div",ue,[s("div",de,[R(p(e.parseDate(n.date)),1),n.updated?(d(),u("span",re,"("+p(e.parseDate(n.updated))+"已更新)",1)):v("",!0)])]),s("div",ce,p(n.text),1),s("div",ve,[s("div",pe,[(d(),u(S,null,T(["👍","❤️","🙏","🫡","❤️‍🔥","😢"],a=>s("button",{class:N(["reaction-btn",{active:e.hasReacted(n,a)}]),key:a,onClick:C=>e.toggleReaction(n,a)},[e.getReactionCount(n,a)>0?(d(),u("div",he,p(e.getReactionUsers(n,a)),1)):v("",!0),s("span",be,p(a),1),s("span",ke,p(e.getReactionCount(n,a)),1)],10,fe)),64))])]),s("div",ge,[s("button",{class:"ui tiny basic blue button",onClick:a=>e.toggleReplyForm(n.actualIndex)},l[8]||(l[8]=[R("回覆  "),s("i",{class:"reply icon"},null,-1)]),8,ye),n.replies&&n.replies.length>0?(d(),u("button",{key:0,class:"ui tiny basic orange button",onClick:a=>e.toggleReplies(n.actualIndex)},[!n.replies||n.replies.length===0||!n.repliesExpanded?(d(),u("span",Ce,l[9]||(l[9]=[R("展開  "),s("i",{class:"expand icon"},null,-1)]))):(d(),u("span",$e,l[10]||(l[10]=[R("收起  "),s("i",{class:"chevron up icon"},null,-1)])))],8,Re)):v("",!0),n.uid===e.uid&&(!n.replies||n.replies.length===0)?(d(),u("button",{key:1,class:"ui tiny basic purple button",onClick:a=>e.editMessage(n.actualIndex)},l[11]||(l[11]=[s("i",{class:"edit icon"},null,-1),s("span",{class:"fat-only"},"編輯",-1)]),8,we)):v("",!0)]),n.replies&&n.replies.length>0?(d(),u("div",_e,[n.repliesExpanded?(d(),u("div",Te,[(d(!0),u(S,null,T(n.replies,(a,C)=>(d(),u("div",{class:"reply",key:C},[l[16]||(l[16]=s("div",{class:"ui divider"},null,-1)),s("div",Me,[e.users&&e.users[a.uid]&&e.users[a.uid].photoURL?(d(),u("img",{key:0,class:"ui avatar image small",src:e.users[a.uid].photoURL},null,8,De)):v("",!0),s("div",Ee,p(a.author),1),s("div",Ie,[s("div",Le,p(e.parseDate(a.date)),1)]),s("div",Ue,p(a.text),1),a.uid===e.uid?(d(),u("div",Oe,[s("div",Be,[(d(),u(S,null,T(["👍","❤️","🙏","🫡","❤️‍🔥","😢"],f=>s("button",{class:N(["reaction-btn",{active:e.hasReacted(a,f)}]),key:f,onClick:D=>e.toggleReplyReaction(a,n.actualIndex,C,f)},[e.getReactionCount(a,f)>0?(d(),u("div",Ve,p(e.getReactionUsers(a,f)),1)):v("",!0),s("span",Fe,p(f),1),s("span",xe,p(e.getReactionCount(a,f)),1)],10,Ne)),64))])])):v("",!0),s("div",Ae,[s("button",{class:"ui tiny basic blue button",onClick:f=>e.toggleReplyForm(n.actualIndex)},l[12]||(l[12]=[R("回覆  "),s("i",{class:"reply icon"},null,-1)]),8,qe),n.replies&&n.replies.length>0?(d(),u("button",{key:0,class:"ui tiny basic orange button",onClick:f=>e.toggleReplies(n.actualIndex)},[!n.replies||n.replies.length===0||!n.repliesExpanded?(d(),u("span",me,l[13]||(l[13]=[R("展開  "),s("i",{class:"expand icon"},null,-1)]))):(d(),u("span",ze,l[14]||(l[14]=[R("收起  "),s("i",{class:"chevron up icon"},null,-1)])))],8,Je)):v("",!0),s("button",{class:"ui tiny basic red button",onClick:f=>e.deleteReply(n.actualIndex,C)},l[15]||(l[15]=[s("i",{class:"trash icon"},null,-1),s("span",{class:"fat-only"},"刪除",-1)]),8,He)])])]))),128))])):(d(),u("div",Se,"共有"+p(n.replies.length)+"則回覆",1))])):v("",!0),e.replyingTo===n.actualIndex?(d(),u("div",Ge,[l[17]||(l[17]=s("div",{class:"ui divider"},null,-1)),O(s("textarea",{class:"reply-textarea","onUpdate:modelValue":l[1]||(l[1]=a=>e.replyText=a),rows:"2",cols:"50",placeholder:"輸入回覆..."},null,512),[[B,e.replyText]]),s("div",Ke,[s("button",{class:"ui primary button",onClick:a=>e.addReply(n.actualIndex)},"發送",8,Pe),s("button",{class:"ui button",onClick:l[2]||(l[2]=(...a)=>e.cancelReply&&e.cancelReply(...a))},"取消")])])):v("",!0)])]))),128))])):v("",!0),e.uid?(d(),u("div",Qe,[l[19]||(l[19]=s("div",{class:"ui divider thin-only"},null,-1)),s("div",We,[l[18]||(l[18]=s("label",null,"輸入留言",-1)),O(s("textarea",{"onUpdate:modelValue":l[3]||(l[3]=n=>e.newMessage=n)},null,512),[[B,e.newMessage]])]),s("div",{class:"ui primary submit button",onClick:l[4]||(l[4]=(...n)=>e.addMessage&&e.addMessage(...n))},"留言")])):v("",!0)])}const Ze=j(ee,[["render",Xe],["__scopeId","data-v-4436089b"]]);export{Ze as default};
