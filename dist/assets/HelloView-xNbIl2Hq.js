import{e as d,f as r,t as S,F as R,h as W,k as ce,w as V,v as fe,g as me,i as u,a7 as ve,_ as ge,d as he,r as p,c as O,o as pe,n as q,a as ye,a8 as we,s as be,a9 as x}from"./index-CEpvWpua.js";const Te={class:"hello-view"},Ae={class:"taiwan-date"},De={class:"pond-container"},Me={class:"pond-canvas",ref:"pondCanvas"},ke={key:0},Se={class:"login-form"},Ce={class:"avatar-selection"},Ge=["value"],_e={key:0,class:"avatar"},$e=["src","alt"],je=["disabled"],ze={key:1},Le={class:"welcome-message"},Re={key:0,class:"avatar"},Ee=["src","alt"],Fe={class:"greeting-form"},Be=["disabled"],Ie={class:"messages-list"},Pe={key:0,class:"message-item"},We={class:"message-header"},Ve={key:0,class:"avatar"},Oe=["src","alt"],qe={key:1,class:"avatar"},xe={class:"time"},He={class:"message-content"};function Ue(l,o,G,_,C,v){return u(),d(R,null,[r("div",Te,[r("h3",Ae,S(l.taiwanDate),1),o[8]||(o[8]=r("h3",{class:"pond-title"},"今日池塘動態",-1)),r("div",De,[r("canvas",Me,null,512)]),l.isLoggedIn?(u(),d("div",ze,[r("div",Le,[r("h2",null,[o[7]||(o[7]=ce("Hi")),l.selectedAvatar.type==="emoji"?(u(),d("span",Re,S(l.selectedAvatar.value),1)):(u(),d("img",{key:1,class:"avatar-img",src:l.selectedAvatar.src,alt:l.selectedAvatar.value},null,8,Ee))]),r("button",{onClick:o[2]||(o[2]=(...n)=>l.logout&&l.logout(...n))},"離開池塘")]),r("div",Fe,[V(r("textarea",{"onUpdate:modelValue":o[3]||(o[3]=n=>l.currentGreeting=n),placeholder:"今天想說些什麼？"},null,512),[[fe,l.currentGreeting,void 0,{trim:!0}]]),r("button",{onClick:o[4]||(o[4]=(...n)=>l.postGreeting&&l.postGreeting(...n)),disabled:!l.currentGreeting},"向大家打招呼！",8,Be)])])):(u(),d("div",ke,[o[6]||(o[6]=r("h2",null,"加入池塘對話！",-1)),r("div",Se,[o[5]||(o[5]=r("label",null,"頭像選擇：",-1)),r("div",Ce,[(u(!0),d(R,null,W(l.availableAvatars,(n,i)=>(u(),d("label",{key:i},[V(r("input",{type:"radio",name:"avatar",value:n,"onUpdate:modelValue":o[0]||(o[0]=w=>l.selectedAvatar=w)},null,8,Ge),[[ve,l.selectedAvatar]]),n.type==="emoji"?(u(),d("span",_e,S(n.value),1)):(u(),d("img",{key:1,class:"avatar-img",src:n.src,alt:n.value},null,8,$e))]))),128))]),r("button",{onClick:o[1]||(o[1]=(...n)=>l.login&&l.login(...n)),disabled:!l.selectedAvatar},"進入池塘",8,je)])]))]),o[10]||(o[10]=r("h3",{class:"messages-title"},"池塘訊息列表",-1)),r("div",Ie,[l.greetingsOnPond.length===0?(u(),d("div",Pe,o[9]||(o[9]=[r("p",{class:"empty-message"},"今天池塘很安靜... 快來打聲招呼吧！",-1)]))):me("",!0),(u(!0),d(R,null,W(l.sortedMessages,n=>(u(),d("div",{class:"message-item",key:n.id},[r("div",We,[n.avatar&&typeof n.avatar=="object"?(u(),d(R,{key:0},[n.avatar.type==="emoji"?(u(),d("span",Ve,S(n.avatar.value),1)):(u(),d("img",{key:1,class:"avatar-img",src:n.avatar.src,alt:n.avatar.value},null,8,Oe))],64)):(u(),d("span",qe,S(n.avatar||"💧"),1)),r("span",xe,S(l.formatTime(n.timestamp)),1)]),r("div",He,S(n.message),1)]))),128))])],64)}const Ne=he({name:"HelloView",setup(){const o=p([...["😊","🥰","🥶","🚀","🌟","☀️","💧","🌳","🪷","🐟","🦈","🐬","🕷️","🪼","🐙","🐠","🐡","🐸"].map(t=>({type:"emoji",value:t}))]),G=p(!1),_=p(null),C=p(""),v=p([]),n=p(null);let i=null,w=null;const $=p([]),b=p([]),B=p(0),H=O(()=>[...v.value].sort((t,e)=>(e.timestamp||0)-(t.timestamp||0)));function U(){const t={timeZone:"Asia/Taipei",year:"numeric",month:"long",day:"numeric",weekday:"long"};return new Date().toLocaleDateString("zh-TW",t)}const N=p(U()),X={id:"default-greeting",avatar:"🌊",message:"來打招呼吧！",timestamp:Date.now(),dateString:new Date().toDateString()},Z=O(()=>{const t=new Date,e={timeZone:"Asia/Taipei"},a=new Date(t.toLocaleString("en-US",e)).toDateString(),s=v.value.filter(c=>{const g=new Date(c.timestamp);return new Date(g.toLocaleString("en-US",e)).toDateString()===a});return s.length>0?s:[X]});function Y(){_.value&&(G.value=!0)}function J(){G.value=!1,_.value=null,C.value=""}function K(){if(!C.value||!G.value)return;const t=new Date,e={id:`msg-${t.getTime()}-${Math.random().toString(16).slice(2)}`,avatar:_.value,message:C.value,timestamp:t.getTime(),dateString:t.toDateString()},a=[...v.value,e];be(x,a).then(()=>{console.log("留言已寫入 Firebase"),n.value&&F(Math.random()*n.value.width,Math.random()*n.value.height),C.value=""}).catch(s=>{console.error("寫入 Firebase 時發生錯誤:",s)})}function Q(){if(!n.value){console.error("Canvas element not found!");return}if(i=n.value.getContext("2d"),!i){console.error("Failed to get 2D context");return}E(),I(),oe(),window.addEventListener("resize",E)}function E(){if(!n.value||!i)return;const t=n.value.parentElement;t&&(n.value.width=t.clientWidth,n.value.height=t.clientHeight)}function I(){if(!Array.isArray(v.value))return;const t=Z.value;t.forEach(a=>{if(!a||!a.id)return;const s=b.value.findIndex(c=>c.id===a.id);s===-1?ee(a):(b.value[s].message=a.message,b.value[s].avatar=a.avatar)});const e=t.map(a=>a.id).filter(Boolean);b.value=b.value.filter(a=>e.includes(a.id))}function ee(t){if(!n.value)return;const e=n.value;let a=null;t.avatar&&t.avatar.type==="image"&&(a=new Image,a.src=t.avatar.src),b.value.push({id:t.id,avatar:t.avatar,message:t.message,x:Math.random()*(e.width-50)+25,y:Math.random()*(e.height-50)+25,vx:(Math.random()-.5)*.8,vy:(Math.random()-.5)*.8,size:30,imageObj:a})}function F(t,e){$.value.push({x:t,y:e,radius:0,maxRadius:40+Math.random()*20,lineWidth:1.5,opacity:.7,speed:.8+Math.random()*.4})}function te(){if(!i||!n.value)return;const t=n.value;i.clearRect(0,0,t.width,t.height);const e=i.createLinearGradient(0,0,0,t.height);e.addColorStop(0,"#a0d8f0"),e.addColorStop(1,"#79c2e6"),i.fillStyle=e,i.fillRect(0,0,t.width,t.height)}function ne(){if(i)for(let t=$.value.length-1;t>=0;t--){const e=$.value[t];i.beginPath(),i.arc(e.x,e.y,e.radius,0,Math.PI*2),i.strokeStyle=`rgba(255, 255, 255, ${e.opacity})`,i.lineWidth=e.lineWidth,i.stroke(),e.radius+=e.speed,e.opacity-=.01,(e.radius>e.maxRadius||e.opacity<=0)&&$.value.splice(t,1)}}function se(t,e,a,s,c,g,h,re,de,ue){if(!e)return;t.font=ue,t.textBaseline="top";const j=[];let A="";for(let T=0;T<e.length;T++){const k=e[T],z=A+k;t.measureText(z).width>c&&A.length>0?(j.push(A),A=k):A=z}A.length>0&&j.push(A);let L=0;j.forEach(T=>{const k=t.measureText(T).width;k>L&&(L=k)});const D=L+h*2+10,M=j.length*g+h*2,f=a-D/2,m=s-M-5;t.fillStyle=re;const y=6;t.beginPath(),t.moveTo(f+y,m),t.lineTo(f+D-y,m),t.quadraticCurveTo(f+D,m,f+D,m+y),t.lineTo(f+D,m+M-y),t.quadraticCurveTo(f+D,m+M,f+D-y,m+M),t.lineTo(f+y,m+M),t.quadraticCurveTo(f,m+M,f,m+M-y),t.lineTo(f,m+y),t.quadraticCurveTo(f,m,f+y,m),t.closePath(),t.fill(),t.fillStyle=de,j.forEach((T,k)=>{const z=t.measureText(T).width,P=z/2+f+h+(L-z)/2;t.fillText(T,P,m+h+k*g)})}function ae(){if(!i||!n.value)return;const t=n.value;b.value.forEach(e=>{var g,h;e.x+=e.vx,e.y+=e.vy;const a=70,s=e.size/2;e.x-s<0?(e.x=s,e.vx*=-1):e.x+s>t.width&&(e.x=t.width-s,e.vx*=-1),e.y-s-a<0?(e.y=s+a,e.vy=Math.abs(e.vy)):e.y+s>t.height&&(e.y=t.height-s,e.vy*=-1);const c=e.message;se(i,c,e.x,e.y-s,130,16,8,"rgba(255, 255, 255, 0.85)","#333","14px sans-serif"),((g=e.avatar)==null?void 0:g.type)==="emoji"?(i.font=`${e.size}px sans-serif`,i.textAlign="center",i.textBaseline="middle",i.fillText(e.avatar.value,e.x,e.y)):((h=e.avatar)==null?void 0:h.type)==="image"&&e.imageObj?i.drawImage(e.imageObj,e.x-e.size/2,e.y-e.size/2,e.size,e.size):(i.font=`${e.size}px sans-serif`,i.textAlign="center",i.textBaseline="middle",i.fillText("💧",e.x,e.y))})}function ie(){if(n.value&&Math.random()<.015){const t=Math.random()*n.value.width,e=Math.random()*n.value.height;F(t,e)}}function oe(){w&&cancelAnimationFrame(w);const t=()=>{te(),ie(),ne(),ae(),w=requestAnimationFrame(t)};t()}function le(t){if(!t)return"";const e=new Date(t),s=new Date().getTime()-e.getTime(),c=Math.floor(s/(60*1e3)),g=Math.floor(s/(60*60*1e3)),h=Math.floor(s/(24*60*60*1e3));return c<60?`${c} 分鐘前`:g<24?`${g} 小時前`:`${h} 天前`}return pe(()=>{q(()=>{Q()}),ye(x,t=>{let e=[];if(t.exists()){const a=t.val();Array.isArray(a)?(e=a,e.forEach((s,c)=>{s.id||(s.id=`fallback-${s.timestamp||c}-${Math.random().toString(16).slice(2)}`),typeof s.message>"u"&&(s.message="")})):a&&typeof a=="object"&&(e=Object.entries(a).map(([s,c])=>({id:s,message:c.message||"",...c})))}v.value=e,q(()=>{I(),v.value.length>B.value&&n.value&&F(Math.random()*n.value.width,Math.random()*n.value.height),B.value=v.value.length})},t=>{console.error("Error fetching data from Firebase:",t),v.value=[],b.value=[]})}),we(()=>{w&&(cancelAnimationFrame(w),w=null),window.removeEventListener("resize",E)}),{availableAvatars:o,isLoggedIn:G,selectedAvatar:_,currentGreeting:C,greetingsOnPond:v,pondCanvas:n,ripples:$,sortedMessages:H,taiwanDate:N,login:Y,logout:J,postGreeting:K,formatTime:le}}}),Ze=ge(Ne,[["render",Ue],["__scopeId","data-v-acaa0cda"]]);export{Ze as default};
