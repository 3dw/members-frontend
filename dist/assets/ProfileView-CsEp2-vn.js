import{C as F}from"./Card-B8M6Xzgg.js";import{a as n,f as u,k as m,v as k,b as t,d as h,l as U,m as c,n as b,p as _,F as V,j as C,q as L,t as v,s as R,e as x,r as A,o as l,_ as M,x as y,y as N,z as S,A as D,B as T}from"./index-CQwRBvaa.js";import{l as w}from"./leaflet-src-Bu0E0bkm.js";import"./mix-O88PJOmL.js";const I={methods:{toList(s){return!s||typeof s!="object"?[]:Object.values(s)},part(s){return String(s).substring(0,100)},toAge(s){return new Date().getFullYear()-parseInt(s)},highlight(s,e){if(!s)return"";if(s=s.replace(/</g,"&lt;").replace(/>/g,"&gt;"),s=s.replace(/&lt;\s*br\/?\s*&gt;/g,"<br/>"),!e||e.startsWith("$"))return s;const r=e.split(/\s+/g);for(const g of r)s=s.replace(new RegExp(g,"gi"),'<span class="highlightedText">$&</span>');return s},getIcon(s){return s&&s.photoURL?s.photoURL:s&&s.name?`https://www.moedict.tw/${s.name}.png`:"https://www.moedict.tw/unknown.png"},countDateDiff(s){return s?new Date(s).toLocaleDateString():""},makeHref(s){if(!s)return"";let e=String(s);return!e.startsWith("http://")&&!e.startsWith("https://")&&(e="http://"+e),e.replace("https://","")},badAge(s){if(!s)return!1;const r=new Date().getFullYear()-parseInt(s);return isNaN(r)},isValid(s){return s&&s.name&&s.share&&s.learner_habit&&s.note&&s.address&&s.latlngColumn!=="undefined,undefined"&&s.latlngColumn!=="36.778261,-119.4179324"&&s.connect_me},asValid(s){return s&&s.name&&s.note&&s.note.length>=20&&s.address&&s.latlngColumn!=="undefined,undefined"&&s.latlngColumn!=="36.778261,-119.4179324"},searchBy(s,e){const g=Object.keys(s).map(p=>s[p]);if(!g)return[];e||(e="");const i=e.split(/[\s&]+/g);let d=g;for(const p of i){let f,o;[f,o]=p.split(/[~-]/),p.match(/(\d+)[~-](\d+)/)?d=d.filter(a=>(this.toAge(a.learner_birth)<=Number(o)&&this.toAge(a.learner_birth))>=f||this.toAge(a.child_birth)<=Number(o)&&this.toAge(a.child_birth)>=f||this.toAge(a.child_birth2)<=Number(o)&&this.toAge(a.child_birth2)>=f):p.match(/(\d+)\+/)?(f=p.split("+")[0],d=d.filter(a=>this.toAge(a.learner_birth)>=Number(f)||this.toAge(a.child_birth)>=Number(f)||this.toAge(a.child_birth2)>=Number(f))):p.match(/(\d+)-/)?(o=p.split("-")[0],d=d.filter(a=>this.toAge(a.learner_birth)<=Number(o)||this.toAge(a.child_birth)<=Number(o)||this.toAge(a.child_birth2)<=Number(o))):d=d.filter(a=>a.name?(a.name+a.address+a.note+a.freetime+a.learner_habit+a.share+a.ask+a.id).includes(p):!1)}return d.sort((p,f)=>(p.lastUpdate||(p.lastUpdate=0),f.lastUpdate||(f.lastUpdate=0),f.lastUpdate-p.lastUpdate)),d}}},q={class:"hello"},E={key:0},B={key:1,class:"ui divider"},G={key:2},Y={key:3},j={key:4},z={class:"ui grid container"},O={key:0,class:"ui stackable two column row"},P={class:"ten wide column"},W={class:"ui fluid card container"},H={key:0,class:"filler"},Z={class:"six wide column"},J={key:0},K={key:1},Q={key:1,class:"filler"},X={key:5,class:"ui container"},$={key:0,class:"ui warning message"},ee={key:0},te={class:"ui form error warning success",id:"main-form"},ie={class:"field"},se={key:0,class:"ui error message"},oe={key:1,class:"ui warning message"},le={class:"field"},re={class:"two fields"},ne={class:"field"},de={key:0},ue=["href"],ae=["src","title","alt"],me={class:"field"},he={key:0},pe=["href"],ge=["src","title","alt"],fe={class:"two fields"},be={class:"field"},ve={class:"field"},we={class:"field"},ke=["value"],ye={class:"field"},Ne=["value"],Ue={key:0},ce={key:1,class:"ui warning message"},_e={key:2,class:"ui error message"},Ve={class:"field"},Ce={key:0},Le={style:{"margin-left":"15px"}},Ae={key:1},De={class:"three fields"},Fe={class:"field"},Re={class:"field"},xe={class:"field"},Me={class:"field"},Se={class:"field"},Te={key:0,class:"ui warning message"},Ie={key:1,class:"ui success message"},qe={key:3,class:"warning"},Ee={key:4,class:"warning"},Be={key:1},Ge={class:"ui vertical buttons"},Ye={key:0},je={key:1};function ze(s,e,r,g,i,d){const p=A("router-link"),f=A("card");return l(),n("div",q,[r.isInApp?(l(),n("p",E,"您正在 App 內使用，故無法登入，請使用一般瀏覽器登入。")):u("",!0),m(t("p",null,[e[22]||(e[22]=h("請先")),U(p,{target:"_blank",to:"/privacy-policy"},{default:c(()=>e[21]||(e[21]=[h("隱私權政策")])),_:1}),e[23]||(e[23]=h("請詳閱並同意"))],512),[[k,i.isNew]]),i.isNew?(l(),n("div",B)):u("",!0),i.isNew?(l(),n("br",G)):u("",!0),i.isNew?(l(),n("br",Y)):u("",!0),i.isNew?(l(),n("br",j)):u("",!0),t("div",z,[i.editing?u("",!0):(l(),n("div",O,[m(t("div",P,[m(t("div",W,[U(f,{h:i.root,full:!0,onLocate:d.locate,onLoginGoogle:d.loginGoogle,uid:r.uid},null,8,["h","onLocate","onLoginGoogle","uid"])],512),[[k,!i.isNew&&!i.editing]])],512),[[k,!i.isNew]]),i.isNew?(l(),n("div",H)):u("",!0),t("div",Z,[m(t("div",{class:"ui massive blue button",onClick:e[0]||(e[0]=(...o)=>d.startEdit&&d.startEdit(...o))},[e[24]||(e[24]=t("i",{class:"edit icon"},null,-1)),e[25]||(e[25]=h("我要")),i.isNew?(l(),n("span",J,"升旗")):(l(),n("span",K,"更新資料"))],512),[[k,r.uid&&!i.editing]])]),i.isNew?(l(),n("div",Q)):u("",!0)]))]),i.editing?(l(),n("div",X,[d.longTimeNoSee()>.25&&!i.isNew?(l(),n("div",$,[e[26]||(e[26]=t("div",{class:"header"},"您的資料已經一年未更新",-1)),d.longTimeNoSee()>.25?(l(),n("span",ee,"目前已被系統隱藏，請立即更新即可恢復顯示。")):u("",!0)])):u("",!0),m(t("form",te,[e[59]||(e[59]=t("h2",{class:"ui header"},"填寫資料",-1)),e[60]||(e[60]=t("div",{class:"sub header"},[h("請填寫以下資料"),t("br"),h("標示"),t("i",{class:"red star"}),h("為必填欄位")],-1)),e[61]||(e[61]=t("h4",{class:"ui dividing header"},"基本資料",-1)),t("div",ie,[e[27]||(e[27]=t("label",{class:"required"},"稱呼",-1)),m(t("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=o=>i.root.name=o),placeholder:"您希望別人如何稱呼您"},null,512),[[b,i.root.name]])]),t("div",{class:_(["field",{error:i.root.address&&(i.root.latlngColumn=="undefined,undefined"||i.root.latlngColumn=="36.778261,-119.4179324")}])},[e[30]||(e[30]=t("label",{class:"required"},"概略地址",-1)),m(t("input",{"onUpdate:modelValue":e[2]||(e[2]=o=>i.root.address=o),placeholder:"請輸入地址"},null,512),[[b,i.root.address,void 0,{trim:!0}]]),i.root.address&&(i.root.latlngColumn=="undefined,undefined"||i.root.latlngColumn=="36.778261,-119.4179324")?(l(),n("div",se,e[28]||(e[28]=[t("div",{class:"header"},"地址格式錯誤",-1),t("p",null,"請確認地址格式是否正確。",-1)]))):u("",!0),d.tooDetail(i.root.address)?(l(),n("div",oe,e[29]||(e[29]=[t("div",{class:"header"},"地址過於詳細",-1),t("p",null,"請提供更詳細的地址。",-1)]))):u("",!0)],2),e[62]||(e[62]=t("h4",{class:"ui header"},[h("地圖位置"),t("div",{class:"sub header"},"請在地圖上選擇位置")],-1)),e[63]||(e[63]=t("div",{id:"map",style:{height:"300px"}},null,-1)),e[64]||(e[64]=t("div",{class:"ui divider"},null,-1)),t("div",le,[e[33]||(e[33]=t("label",null,"網站網址",-1)),t("div",re,[t("div",ne,[m(t("input",{"onUpdate:modelValue":e[3]||(e[3]=o=>i.root.site=o),placeholder:"請輸入個人網站網址"},null,512),[[b,i.root.site]]),i.root.site?(l(),n("span",de,[t("a",{href:i.root.site,target:"_blank"},[t("img",{src:"https://www.google.com/s2/favicons?domain="+i.root.site,title:i.root.site,alt:i.root.site},null,8,ae),e[31]||(e[31]=h("測試連結"))],8,ue)])):u("",!0)]),t("div",me,[m(t("input",{"onUpdate:modelValue":e[4]||(e[4]=o=>i.root.site2=o),placeholder:"請輸入社群網站網址"},null,512),[[b,i.root.site2]]),i.root.site2?(l(),n("span",he,[t("a",{href:i.root.site2,target:"_blank"},[t("img",{src:"https://www.google.com/s2/favicons?domain="+i.root.site2,title:i.root.site2,alt:i.root.site2},null,8,ge),e[32]||(e[32]=h("測試連結"))],8,pe)])):u("",!0)])])]),t("div",fe,[t("div",be,[e[34]||(e[34]=t("label",{class:"required"},"聯絡方式",-1)),m(t("input",{"onUpdate:modelValue":e[5]||(e[5]=o=>i.root.connect_me=o),placeholder:"請輸入聯絡方式"},null,512),[[b,i.root.connect_me]])]),t("div",ve,[e[35]||(e[35]=t("label",null,"空閒時間",-1)),m(t("input",{type:"text","onUpdate:modelValue":e[6]||(e[6]=o=>i.root.freetime=o),placeholder:"請輸入空閒時間"},null,512),[[b,i.root.freetime]])])]),e[65]||(e[65]=t("h4",{class:"ui dividing header"},"角色與類型",-1)),t("div",we,[e[37]||(e[37]=t("label",null,"角色",-1)),m(t("select",{class:"selectpicker","onUpdate:modelValue":e[7]||(e[7]=o=>i.root.learner_role=o)},[e[36]||(e[36]=t("option",{value:""},"-- 請選擇角色 --",-1)),(l(),n(V,null,C(["準會員","一般會員","理事","監事","常務理事","常務監事","理事長","其他"],o=>t("option",{value:o},v(o),9,ke)),64))],512),[[L,i.root.learner_role]])]),t("div",ye,[e[39]||(e[39]=t("label",null,"類型",-1)),m(t("select",{class:"selectpicker","onUpdate:modelValue":e[8]||(e[8]=o=>i.root.learner_type=o)},[e[38]||(e[38]=t("option",{value:""},"-- 請選擇類型 --",-1)),(l(),n(V,null,C(["準會員","一般會員","志工","教師","其他"],o=>t("option",{value:o},v(o),9,Ne)),64))],512),[[L,i.root.learner_type]])]),t("div",{class:_(["field",{error:s.badAge(i.root.learner_birth),warning:!i.root.learner_birth}])},[e[40]||(e[40]=t("label",{class:"required"},"出生年份",-1)),m(t("input",{type:"text","onUpdate:modelValue":e[9]||(e[9]=o=>i.root.learner_birth=o),placeholder:"請輸入出生年份"},null,512),[[b,i.root.learner_birth]])],2),i.root.learner_birth?(l(),n("span",Ue,"您已經 "+v(s.toAge(i.root.learner_birth))+" 歲",1)):u("",!0),i.root.learner_birth?u("",!0):(l(),n("div",ce,e[41]||(e[41]=[t("div",{class:"header"},"出生年份未填寫",-1),t("p",null,"請填寫出生年份。",-1)]))),s.badAge(i.root.learner_birth)?(l(),n("div",_e,e[42]||(e[42]=[t("div",{class:"header"},"出生年份格式錯誤",-1),t("p",null,"請確認出生年份格式是否正確。",-1)]))):u("",!0),t("div",Ve,[e[55]||(e[55]=t("label",null,"最大孩子出生年份",-1)),t("span",null,[m(t("input",{"onUpdate:modelValue":e[10]||(e[10]=o=>i.root.child_birth=o),type:"text",placeholder:"請輸入子女出生年份"},null,512),[[b,i.root.child_birth]]),e[46]||(e[46]=t("br",null,null,-1)),i.root.child_birth?(l(),n("span",Ce,"您的孩子已經 "+v(s.toAge(i.root.child_birth))+" 歲",1)):u("",!0),e[47]||(e[47]=t("div",{class:"ui divider"},null,-1)),t("span",Le,[e[43]||(e[43]=h("最小孩子出生年份")),e[44]||(e[44]=t("br",null,null,-1)),m(t("input",{"onUpdate:modelValue":e[11]||(e[11]=o=>i.root.child_birth2=o),type:"text",placeholder:"請輸入子女出生年份"},null,512),[[b,i.root.child_birth2]]),e[45]||(e[45]=t("br",null,null,-1))]),i.root.child_birth2?(l(),n("span",Ae,"您的子女出生於 "+v(s.toAge(i.root.child_birth2))+" 歲至 "+v(s.toAge(i.root.child_birth))+" 歲",1)):u("",!0)]),e[56]||(e[56]=t("div",{class:"ui divider"},null,-1)),t("div",De,[t("div",Fe,[e[48]||(e[48]=t("label",{class:"required"},"興趣",-1)),m(t("input",{"onUpdate:modelValue":e[12]||(e[12]=o=>i.root.learner_habit=o),placeholder:"請輸入興趣"},null,512),[[b,i.root.learner_habit]])]),t("div",Re,[e[49]||(e[49]=t("label",{class:"required"},"分享",-1)),m(t("input",{"onUpdate:modelValue":e[13]||(e[13]=o=>i.root.share=o),placeholder:"請輸入分享"},null,512),[[b,i.root.share]])]),t("div",xe,[e[50]||(e[50]=t("label",null,"尋找",-1)),m(t("input",{"onUpdate:modelValue":e[14]||(e[14]=o=>i.root.ask=o),placeholder:"請輸入詢問"},null,512),[[b,i.root.ask]])]),t("div",Me,[e[51]||(e[51]=t("label",null,"可支付",-1)),m(t("input",{"onUpdate:modelValue":e[15]||(e[15]=o=>i.root.price=o),placeholder:"請輸入可支付"},null,512),[[b,i.root.price]])])]),t("div",Se,[e[52]||(e[52]=t("label",{class:"required"},"自我介紹",-1)),m(t("textarea",{id:"note","onUpdate:modelValue":e[16]||(e[16]=o=>i.root.note=o),rows:"5",cols:"30",placeholder:"請輸入自我介紹"},null,512),[[b,i.root.note]])]),i.root.note&&i.root.note.length<20?(l(),n("div",Te,e[53]||(e[53]=[t("div",{class:"header"},"自我介紹過短",-1),t("p",null,"請至少輸入 20 個字。",-1)]))):u("",!0),i.root.note&&i.root.note.length>=20?(l(),n("div",Ie,e[54]||(e[54]=[t("div",{class:"header"},"自我介紹已達標準",-1),t("p",null,"自我介紹已達到 20 個字以上。",-1)]))):u("",!0)]),!r.emailVerified&&i.root.login_method==="email"?(l(),n("div",qe,[e[57]||(e[57]=h("note: 您的Email尚未驗證")),t("button",{class:"ui button",onClick:e[17]||(e[17]=o=>s.$emit("resendVerificationEmail"))},"按此重發驗證信")])):u("",!0),d.isValid(i.root)?u("",!0):(l(),n("div",Ee,e[58]||(e[58]=[h("note: 資料不完整"),t("i",{class:"red star"},null,-1),h("請確認所有欄位是否填寫完整。")])))],512),[[k,i.editing]]),i.isNew?(l(),n("p",Be,[m(t("input",{class:"ui checkbox",type:"checkbox","onUpdate:modelValue":e[18]||(e[18]=o=>i.agree=o)},null,512),[[R,i.agree]]),e[67]||(e[67]=h("我已閱讀並同意")),U(p,{target:"_blank",to:"/privacy-policy"},{default:c(()=>e[66]||(e[66]=[h("隱私權政策")])),_:1})])):u("",!0),t("div",Ge,[t("button",{class:_(["ui large primary button",{disabled:!d.isValid(i.root)||!r.emailVerified&&i.root.login_method==="email"}]),onClick:e[19]||(e[19]=(...o)=>d.updateFlag&&d.updateFlag(...o))},[i.isNew?(l(),n("span",Ye,e[68]||(e[68]=[t("i",{class:"flag icon"},null,-1),h("升旗")]))):(l(),n("span",je,e[69]||(e[69]=[t("i",{class:"flag icon"},null,-1),h("更新資料")])))],2),i.isNew?u("",!0):(l(),x(p,{key:0,class:"ui large basic primary button",to:"/flag/"+r.uid},{default:c(()=>e[70]||(e[70]=[t("i",{class:"user icon"},null,-1),h("檢查旗幟"),t("i",{class:"chevron right icon"},null,-1)])),_:1},8,["to"])),i.isNew?u("",!0):(l(),n("div",{key:1,class:"ui large red button",onClick:e[20]||(e[20]=(...o)=>d.confirmDelete&&d.confirmDelete(...o))},e[71]||(e[71]=[t("i",{class:"delete icon"},null,-1),h("刪除旗幟")])))]),e[72]||(e[72]=t("br",null,null,-1)),e[73]||(e[73]=t("br",null,null,-1)),e[74]||(e[74]=t("br",null,null,-1)),e[75]||(e[75]=t("br",null,null,-1))])):u("",!0)])}const Oe={name:"MyFlag",props:["uid","user","emailVerified","email","mySearch","provider","photoURL","isInApp"],components:{Card:F},mixins:[I],metaInfo:{title:"個人資料"},data(){return{agree:!1,root:{latlngColumn:"23.5330,121.0654"},local:{},map:null,marker:null,isNew:!0,editing:!1}},emits:["loginGoogle","locate"],watch:{uid(s){s&&this.fetchUserData()}},mounted(){this.uid?this.fetchUserData():console.log("請先登入")},methods:{isValid(){return!this.root.note||this.root.note.length<20?!1:[this.root.name,this.root.address,this.root.connect_me,this.root.learner_birth,this.root.learner_habit,this.root.share,this.root.note].every(e=>e&&e.trim()!=="")},startEdit(){this.editing=!0,w.Icon.Default.imagePath="//cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/",setTimeout(this.initMap,500),setTimeout(this.setMapAndMarker,1e3),this.root.email||this.fetchUserData()},initMap(){let e=[23.533,121.0654];if(typeof this.root.latlngColumn=="string"){const r=this.root.latlngColumn.split(",");if(r.length===2){const g=parseFloat(r[0]),i=parseFloat(r[1]);!isNaN(g)&&!isNaN(i)&&(e=[g,i])}}this.map=w.map("map").setView(e,7),w.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(this.map),w.Icon.Default.imagePath="//cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/",this.marker=w.marker(this.map.getCenter(),{draggable:!0}).addTo(this.map),this.marker.on("dragend",()=>{const{lat:r,lng:g}=this.marker.getLatLng();this.map.setView({lat:r,lng:g}),this.root.latlngColumn=`${r.toFixed(5)},${g.toFixed(5)}`,this.$forceUpdate()})},fetchUserData(){const s=y(N,"users/"+this.uid);S(s).then(e=>{if(e.exists()){this.isNew=!1,this.root=e.val();let r=[...this.user&&this.user.providerData||[]];r.length===0&&(r=[{displayName:(this.root.email||"").split("@")[0]||"Unknown",email:this.root.email,photoURL:this.root.photoURL||"https://we.alearn.org.tw/logo-new.png"}]),this.root.email=this.root.email||this.email,this.root.connect_me=this.root.connect_me||this.email,this.root.name=this.root.name||this.user.name||r[0].displayName||"新朋友",this.root.photoURL=this.root.photoURL||decodeURI(this.user.photoURL)||"https://we.alearn.org.tw/logo-new.png",this.root.login_method=this.root.login_method||"google"}else{console.log("No data available for user: "+this.uid);let r=[...this.user&&this.user.providerData||[]];r.length===0&&(r=[{displayName:(this.root.email||"").split("@")[0]||"新朋友",email:this.root.email||"",photoURL:this.root.photoURL||"https://we.alearn.org.tw/logo-new.png",login_method:"email"}]),this.root={name:r[0].displayName,uid:this.uid,email:this.email,connect_me:this.email,photoURL:this.root.photoURL,latlngColumn:"23.5330,121.0654",note:"",login_method:this.root.login_method||"google"},this.isNew=!0}}).catch(e=>{console.error(e),console.log("No data available for user: "+this.uid),console.log(this.user);let r=[...this.user&&this.user.providerData||[]];r.length===0&&(r=[{displayName:(this.root.email||"").split("@")[0]||"新朋友",email:this.root.email||"",photoURL:this.root.photoURL||"https://we.alearn.org.tw/logo-new.png"}]),this.root={name:r[0].displayName,uid:this.uid,email:this.email,connect_me:this.email,photoURL:this.root.photoURL,latlngColumn:"23.5330,121.0654",note:"",login_method:this.root.login_method||"google"},this.isNew=!0})},setMapAndMarker(){if(this.map&&this.marker){let e=[23.533,121.0654];if(this.root&&typeof this.root.latlngColumn=="string"){const g=this.root.latlngColumn.split(",");if(g.length===2){const i=parseFloat(g[0]),d=parseFloat(g[1]);!isNaN(i)&&!isNaN(d)&&(e=[i,d])}}const r=w.latLng(e[0],e[1]);this.map.setView(r,7),this.marker.setLatLng(r)}},longTimeNoSee(){return this.root.lastUpdate?(new Date().getTime()-this.root.lastUpdate)/1e3/3600/24/365.25:1/0},tooDetail:function(s){return s?!!s.match(/(號|樓|F|f)/):!1},updateFlag:function(){if(this.root.email=this.email||"",this.root.uid=this.uid||"",this.root.photoURL=this.photoURL||"",this.root.lastUpdate=new Date().getTime(),!this.emailVerified&&this.root.login_method==="email"&&alert("Email尚未驗證"),!this.isNew)this.isNew=!1,this.editing=!1,D(y(N,"users/"+this.uid),this.root).then(alert("更新成功"));else if(this.agree)console.log("new2"),this.isNew=!1,this.editing=!1,D(y(N,"users/"+this.uid),this.root).then(alert("升旗成功"));else{window.alert("請先閱讀並同意隱私權政策");return}this.$emit("locate",this.root,!1)},confirmDelete(){window.confirm("確認要刪除旗幟嗎？此動作無法復原。")&&this.deleteFlag()},deleteFlag(){const s=this.uid;T(y(N,"users/"+s)).then(()=>{alert("刪除成功"),this.root={},this.$emit("logout")}).catch(e=>{alert("刪除失敗："+e.message)})},loginFB:function(){this.$emit("loginFB")},locate:function(s,e){this.$emit("locate",s,e)},loginGoogle:function(){this.$emit("loginGoogle")}}},Je=M(Oe,[["render",ze],["__scopeId","data-v-53418988"]]);export{Je as default};
