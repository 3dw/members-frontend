import{g as d,h as r,t as S,F as L,j as P,l as ue,w as V,v as ce,i as fe,k as u,a7 as me,_ as ve,d as ge,r as p,c as W,o as he,n as O,a as pe,a8 as ye,s as we,a9 as q}from"./index-B5XOrBgH.js";const be={class:"hello-view"},Ae={class:"taiwan-date"},Te={class:"pond-container"},De={class:"pond-canvas",ref:"pondCanvas"},Me={key:0},ke={class:"login-form"},Se={class:"avatar-selection"},Ce=["value"],Ge={key:0,class:"avatar"},_e=["src","alt"],je=["disabled"],$e={key:1},ze={class:"welcome-message"},Le={key:0,class:"avatar"},Re=["src","alt"],Ee={class:"greeting-form"},Fe=["disabled"],Be={class:"messages-list"},Ie={key:0,class:"message-item"},Pe={class:"message-header"},Ve={key:0,class:"avatar"},We=["src","alt"],Oe={key:1,class:"avatar"},qe={class:"time"},xe={class:"message-content"};function He(l,o,G,_,C,v){return u(),d(L,null,[r("div",be,[r("h3",Ae,S(l.taiwanDate),1),o[8]||(o[8]=r("h3",{class:"pond-title"},"今日池塘動態",-1)),r("div",Te,[r("canvas",De,null,512)]),l.isLoggedIn?(u(),d("div",$e,[r("div",ze,[r("h2",null,[o[7]||(o[7]=ue("Hi")),l.selectedAvatar.type==="emoji"?(u(),d("span",Le,S(l.selectedAvatar.value),1)):(u(),d("img",{key:1,class:"avatar-img",src:l.selectedAvatar.src,alt:l.selectedAvatar.value},null,8,Re))]),r("button",{onClick:o[2]||(o[2]=(...n)=>l.logout&&l.logout(...n))},"離開池塘")]),r("div",Ee,[V(r("textarea",{"onUpdate:modelValue":o[3]||(o[3]=n=>l.currentGreeting=n),placeholder:"今天想說些什麼？"},null,512),[[ce,l.currentGreeting,void 0,{trim:!0}]]),r("button",{onClick:o[4]||(o[4]=(...n)=>l.postGreeting&&l.postGreeting(...n)),disabled:!l.currentGreeting},"向大家打招呼！",8,Fe)])])):(u(),d("div",Me,[o[6]||(o[6]=r("h2",null,"加入池塘對話！",-1)),r("div",ke,[o[5]||(o[5]=r("label",null,"頭像選擇：",-1)),r("div",Se,[(u(!0),d(L,null,P(l.availableAvatars,(n,i)=>(u(),d("label",{key:i},[V(r("input",{type:"radio",name:"avatar",value:n,"onUpdate:modelValue":o[0]||(o[0]=w=>l.selectedAvatar=w)},null,8,Ce),[[me,l.selectedAvatar]]),n.type==="emoji"?(u(),d("span",Ge,S(n.value),1)):(u(),d("img",{key:1,class:"avatar-img",src:n.src,alt:n.value},null,8,_e))]))),128))]),r("button",{onClick:o[1]||(o[1]=(...n)=>l.login&&l.login(...n)),disabled:!l.selectedAvatar},"進入池塘",8,je)])]))]),o[10]||(o[10]=r("h3",{class:"messages-title"},"池塘訊息列表",-1)),r("div",Be,[l.greetingsOnPond.length===0?(u(),d("div",Ie,o[9]||(o[9]=[r("p",{class:"empty-message"},"今天池塘很安靜... 快來打聲招呼吧！",-1)]))):fe("",!0),(u(!0),d(L,null,P(l.sortedMessages,n=>(u(),d("div",{class:"message-item",key:n.id},[r("div",Pe,[n.avatar&&typeof n.avatar=="object"?(u(),d(L,{key:0},[n.avatar.type==="emoji"?(u(),d("span",Ve,S(n.avatar.value),1)):(u(),d("img",{key:1,class:"avatar-img",src:n.avatar.src,alt:n.avatar.value},null,8,We))],64)):(u(),d("span",Oe,S(n.avatar||"💧"),1)),r("span",qe,S(l.formatTime(n.timestamp)),1)]),r("div",xe,S(n.message),1)]))),128))])],64)}const Ue=ge({name:"HelloView",setup(){const o=p([...["😊","🥰","🥶","🚀","🌟","☀️","💧","🌳","🪷","🐟","🦈","🐬","🕷️","🪼","🐙","🐠","🐡","🐸"].map(t=>({type:"emoji",value:t}))]),G=p(!1),_=p(null),C=p(""),v=p([]),n=p(null);let i=null,w=null;const j=p([]),b=p([]),B=p(0),x=W(()=>[...v.value].sort((t,e)=>(e.timestamp||0)-(t.timestamp||0)));function H(){const t={timeZone:"Asia/Taipei",year:"numeric",month:"long",day:"numeric",weekday:"long"};return new Date().toLocaleDateString("zh-TW",t)}const U=p(H()),N={id:"default-greeting",avatar:"🌊",message:"來打招呼吧！",timestamp:Date.now(),dateString:new Date().toDateString()},X=W(()=>{const t=new Date,e={timeZone:"Asia/Taipei"},a=new Date(t.toLocaleString("en-US",e)).toDateString(),s=v.value.filter(c=>{const g=new Date(c.timestamp);return new Date(g.toLocaleString("en-US",e)).toDateString()===a});return s.length>0?s:[N]});function Z(){_.value&&(G.value=!0)}function Y(){G.value=!1,_.value=null,C.value=""}function J(){if(!C.value||!G.value)return;const t=new Date,e={id:`msg-${t.getTime()}-${Math.random().toString(16).slice(2)}`,avatar:_.value,message:C.value,timestamp:t.getTime(),dateString:t.toDateString()},a=[...v.value,e];we(q,a).then(()=>{console.log("留言已寫入 Firebase"),n.value&&E(Math.random()*n.value.width,Math.random()*n.value.height),C.value=""}).catch(s=>{console.error("寫入 Firebase 時發生錯誤:",s)})}function K(){if(!n.value){console.error("Canvas element not found!");return}if(i=n.value.getContext("2d"),!i){console.error("Failed to get 2D context");return}R(),I(),ie(),window.addEventListener("resize",R)}function R(){if(!n.value||!i)return;const t=n.value.parentElement;t&&(n.value.width=t.clientWidth,n.value.height=t.clientHeight)}function I(){if(!Array.isArray(v.value))return;const t=X.value;t.forEach(a=>{if(!a||!a.id)return;const s=b.value.findIndex(c=>c.id===a.id);s===-1?Q(a):(b.value[s].message=a.message,b.value[s].avatar=a.avatar)});const e=t.map(a=>a.id).filter(Boolean);b.value=b.value.filter(a=>e.includes(a.id))}function Q(t){if(!n.value)return;const e=n.value;let a=null;t.avatar&&t.avatar.type==="image"&&(a=new Image,a.src=t.avatar.src),b.value.push({id:t.id,avatar:t.avatar,message:t.message,x:Math.random()*(e.width-50)+25,y:Math.random()*(e.height-50)+25,vx:(Math.random()-.5)*.8,vy:(Math.random()-.5)*.8,size:30,imageObj:a})}function E(t,e){j.value.push({x:t,y:e,radius:0,maxRadius:40+Math.random()*20,lineWidth:1.5,opacity:.7,speed:.8+Math.random()*.4})}function ee(){if(!i||!n.value)return;const t=n.value;i.clearRect(0,0,t.width,t.height);const e=i.createLinearGradient(0,0,0,t.height);e.addColorStop(0,"#a0d8f0"),e.addColorStop(1,"#79c2e6"),i.fillStyle=e,i.fillRect(0,0,t.width,t.height)}function te(){if(i)for(let t=j.value.length-1;t>=0;t--){const e=j.value[t];i.beginPath(),i.arc(e.x,e.y,e.radius,0,Math.PI*2),i.strokeStyle=`rgba(255, 255, 255, ${e.opacity})`,i.lineWidth=e.lineWidth,i.stroke(),e.radius+=e.speed,e.opacity-=.01,(e.radius>e.maxRadius||e.opacity<=0)&&j.value.splice(t,1)}}function ne(t,e,a,s,c,g,h,le,re,de){if(!e)return;t.font=de,t.textBaseline="top",t.textAlign="left";const $=[];let A="";for(let M=0;M<e.length;M++){const k=e[M],z=A+k;t.measureText(z).width>c&&A.length>0?($.push(A),A=k):A=z}A.length>0&&$.push(A);let F=0;$.forEach(M=>{const k=t.measureText(M).width;k>F&&(F=k)});const T=F+h*2+10,D=$.length*g+h*2,f=a-T/2,m=s-D-5;t.fillStyle=le;const y=6;t.beginPath(),t.moveTo(f+y,m),t.lineTo(f+T-y,m),t.quadraticCurveTo(f+T,m,f+T,m+y),t.lineTo(f+T,m+D-y),t.quadraticCurveTo(f+T,m+D,f+T-y,m+D),t.lineTo(f+y,m+D),t.quadraticCurveTo(f,m+D,f,m+D-y),t.lineTo(f,m+y),t.quadraticCurveTo(f,m,f+y,m),t.closePath(),t.fill(),t.fillStyle=re,$.forEach((M,k)=>{const z=f+h;t.fillText(M,z,m+h+k*g)})}function se(){if(!i||!n.value)return;const t=n.value;b.value.forEach(e=>{var g,h;e.x+=e.vx,e.y+=e.vy;const a=70,s=e.size/2;e.x-s<0?(e.x=s,e.vx*=-1):e.x+s>t.width&&(e.x=t.width-s,e.vx*=-1),e.y-s-a<0?(e.y=s+a,e.vy=Math.abs(e.vy)):e.y+s>t.height&&(e.y=t.height-s,e.vy*=-1);const c=e.message;ne(i,c,e.x,e.y-s,130,16,8,"rgba(255, 255, 255, 0.85)","#333","14px sans-serif"),((g=e.avatar)==null?void 0:g.type)==="emoji"?(i.font=`${e.size}px sans-serif`,i.textAlign="center",i.textBaseline="middle",i.fillText(e.avatar.value,e.x,e.y)):((h=e.avatar)==null?void 0:h.type)==="image"&&e.imageObj?i.drawImage(e.imageObj,e.x-e.size/2,e.y-e.size/2,e.size,e.size):(i.font=`${e.size}px sans-serif`,i.textAlign="center",i.textBaseline="middle",i.fillText("💧",e.x,e.y))})}function ae(){if(n.value&&Math.random()<.015){const t=Math.random()*n.value.width,e=Math.random()*n.value.height;E(t,e)}}function ie(){w&&cancelAnimationFrame(w);const t=()=>{ee(),ae(),te(),se(),w=requestAnimationFrame(t)};t()}function oe(t){if(!t)return"";const e=new Date(t),s=new Date().getTime()-e.getTime(),c=Math.floor(s/(60*1e3)),g=Math.floor(s/(60*60*1e3)),h=Math.floor(s/(24*60*60*1e3));return c<60?`${c} 分鐘前`:g<24?`${g} 小時前`:`${h} 天前`}return he(()=>{O(()=>{K()}),pe(q,t=>{let e=[];if(t.exists()){const a=t.val();Array.isArray(a)?(e=a,e.forEach((s,c)=>{s.id||(s.id=`fallback-${s.timestamp||c}-${Math.random().toString(16).slice(2)}`),typeof s.message>"u"&&(s.message="")})):a&&typeof a=="object"&&(e=Object.entries(a).map(([s,c])=>({id:s,message:c.message||"",...c})))}v.value=e,O(()=>{I(),v.value.length>B.value&&n.value&&E(Math.random()*n.value.width,Math.random()*n.value.height),B.value=v.value.length})},t=>{console.error("Error fetching data from Firebase:",t),v.value=[],b.value=[]})}),ye(()=>{w&&(cancelAnimationFrame(w),w=null),window.removeEventListener("resize",R)}),{availableAvatars:o,isLoggedIn:G,selectedAvatar:_,currentGreeting:C,greetingsOnPond:v,pondCanvas:n,ripples:j,sortedMessages:x,taiwanDate:U,login:Z,logout:Y,postGreeting:J,formatTime:oe}}}),Ze=ve(Ue,[["render",He],["__scopeId","data-v-54b9956d"]]);export{Ze as default};
